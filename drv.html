<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>drv view</title>
<dl>
  <dt>Outputs</dt>
  <dd>
    <table id="outputs" border="1">
      <thead>
        <tr>
          <td>Name</td>
          <td>Path</td>
          <td>Hash algorithm</td>
          <td>Hash</td>
        </tr>
      </thead>
    </table>
  </dd>
  <dt>Input derivations</dt>
  <dd>
    <table id="input_drvs" border="1">
      <thead>
        <tr>
          <td>Path</td>
          <td>Outputs</td>
        </tr>
      </thead>
    </table>
  </dd>
  <dt>Input sources</dt>
  <dd><ul id="input_srcs"></ul></dd>
  <dt>Platform</dt>
  <dd id="platform"></dd>
  <dt>Builder</dt>
  <dd id="builder"></dd>
  <dt>Builder arguments</dt>
  <dd><ol id="builder_args"></ol></dd>
  <dt>Builder environment</dt>
  <dd>
    <table id="env" border="1">
      <thead>
        <tr>
          <td>Name</td>
          <td>Value</td>
        </tr>
      </thead>
    </table>
  </dd>
</dl>
<script src="misc.js"></script>
<script>
  (async () => {
    try {
      const options = new URL(window.location).searchParams;
      const cacheBase = options.get('cache_base');
      const hash = options.get('hash');

      const drvNarinfo = await cacheGetNarinfo(cacheBase, hash);

      const rootPath = narinfoPath(drvNarinfo);
      const rootName = pathName(rootPath);
      document.title = rootName;

      const drvNar = await cacheGetNar(cacheBase, drvNarinfo);
      const drv = drvParse(new TextDecoder().decode(drvNar.root.contents));

      const [outputs, inputDrvs, inputSrcs, platform, builder, builderArgs, env] = drv;
      const vOutputs = document.getElementById('outputs');
      for (const [name, path, narHashAlgorithm, narHash] of outputs) {
        const row = vOutputs.insertRow(-1);
        row.insertCell(-1).textContent = name;
        const pathCell = row.insertCell(-1);
        const pathLink = document.createElement('a');
        const cacheBaseBin = 'https://cdn.glitch.me/35f4f809-f949-484d-af9c-269b3b7abc78/'; // %%%
        const outputHash = /([0-9a-z]+)-[^/]+/.exec(path)[1];
        pathLink.href = `nar.html?cache_base=${encodeURIComponent(cacheBaseBin)}&hash=${encodeURIComponent(outputHash)}`;
        pathLink.textContent = path;
        pathCell.appendChild(pathLink);
        row.insertCell(-1).textContent = narHashAlgorithm;
        row.insertCell(-1).textContent = narHash;
      }
      const vInputDrvs = document.getElementById('input_drvs');
      for (const [drvPath, drvOutputs] of inputDrvs) {
        const row = vInputDrvs.insertRow(-1);
        const drvCell = row.insertCell(-1);
        const drvLink = document.createElement('a');
        const drvHash = /([0-9a-z]+)-[^/]+/.exec(drvPath)[1];
        drvLink.href = `?cache_base=${encodeURIComponent(cacheBase)}&hash=${encodeURIComponent(drvHash)}`;
        drvLink.textContent = drvPath;
        drvCell.appendChild(drvLink);
        row.insertCell(-1).textContent = drvOutputs.join(', ');
      }
      const vInputSrcs = document.getElementById('input_srcs');
      for (const inputSrc of inputSrcs) {
        const item = document.createElement('li');
        const inputSrcLink = document.createElement('a');
        const inputSrcHash = pathHash(inputSrc);
        inputSrcLink.href = `nar.html?cache_base=${encodeURIComponent(cacheBase)}&hash=${encodeURIComponent(inputSrcHash)}`;
        inputSrcLink.textContent = inputSrc;
        item.appendChild(inputSrcLink);
        vInputSrcs.appendChild(item);
      }
      document.getElementById('platform').textContent = platform;
      document.getElementById('builder').textContent = builder;
      const vBuilderArgs = document.getElementById('builder_args');
      for (const builderArg of builderArgs) {
        const item = document.createElement('li');
        item.textContent = builderArg;
        vBuilderArgs.appendChild(item);
      }
      const vEnv = document.getElementById('env');
      for (const [name, value] of env) {
        const row = vEnv.insertRow(-1);
        row.insertCell(-1).textContent = name;
        row.insertCell(-1).textContent = value;
      }
    } catch (e) {
      console.error(e);
    }
  })();
</script>
